<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moment 3: Your Goals - Vibe</title>
    <link rel="stylesheet" href="css/common.css">
</head>
<body>
    <div class="container">
        <!-- Progress Bar -->
        <div id="progress-container"></div>

        <!-- Header -->
        <div id="header-container"></div>

        <!-- Main Content -->
        <div class="card">
            <h3>Set Your 3 Goals</h3>
            <p>What do you need to achieve to make your mission real? Most new businesses focus on 3 main areas:</p>
            <ul>
                <li><strong>Building capability</strong> - What skills or products do you need?</li>
                <li><strong>Finding customers</strong> - Who will pay and how will they find you?</li>
                <li><strong>Setting up operations</strong> - What do you need to actually run this?</li>
            </ul>
        </div>

        <!-- Mission Reminder -->
        <div class="card" style="background: var(--background);">
            <p style="margin-bottom: 8px; font-size: 14px; color: var(--text-muted);">Your mission:</p>
            <p id="mission-reminder" style="margin-bottom: 0; font-style: italic;"></p>
        </div>

        <!-- Goals Input -->
        <div class="card">
            <div class="form-group">
                <label for="objectives_0">Goal 1: What's your first priority?</label>
                <input
                    type="text"
                    id="objectives_0"
                    data-field="objectives.0"
                    placeholder="e.g., Learn the skills I need to..."
                >
            </div>

            <div class="form-group">
                <label for="objectives_1">Goal 2: What else matters for success?</label>
                <input
                    type="text"
                    id="objectives_1"
                    data-field="objectives.1"
                    placeholder="e.g., Find my first customers by..."
                >
            </div>

            <div class="form-group">
                <label for="objectives_2">Goal 3: What foundation do you need?</label>
                <input
                    type="text"
                    id="objectives_2"
                    data-field="objectives.2"
                    placeholder="e.g., Set up my workspace for..."
                >
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-icon">AI</div>
                <div class="chat-header-title">AI Coach</div>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="chat-message assistant">
                    <div class="chat-avatar">AI</div>
                    <div class="chat-bubble">
                        <p style="margin: 0;">Now the hard part: what has to happen for your mission to become real?<br><br>Most people write goals that are too vague ("grow the business") or too easy ("make a logo"). I'll push you toward goals that actually matter — things that, if you don't achieve them, the business won't work.</p>
                    </div>
                </div>
            </div>

            <!-- Quick Replies -->
            <div class="quick-replies" style="padding: 0 16px;">
                <button class="quick-reply-btn" onclick="askQuestion('Challenge my goals')">Challenge my goals</button>
                <button class="quick-reply-btn" onclick="askQuestion('What worked for others?')">What worked for others?</button>
                <button class="quick-reply-btn" onclick="askQuestion('Which goal matters most?')">Which matters most?</button>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <input
                    type="text"
                    class="chat-input"
                    id="chat-input"
                    placeholder="Ask me anything..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="chat-send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Example -->
        <div class="example-box">
            <div class="example-header">Maria's 3 Goals</div>
            <div class="example-content">
                1. Build my meal prep skills and recipe collection<br>
                2. Find my first paying customers<br>
                3. Set up reliable operations (kitchen, supplies, schedule)
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div id="nav-container"></div>
        </div>
    </div>

    <script src="js/session.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/demo.js"></script>
    <script>
        const MOMENT_ID = 3;

        document.addEventListener('DOMContentLoaded', () => {
            Navigation.init(MOMENT_ID);
            Navigation.renderNavButtons('nav-container', MOMENT_ID, {
                nextLabel: 'Save & Continue to Actions',
                onNext: 'saveAndContinue()'
            });

            // Initialize demo mode if active
            Demo.init(MOMENT_ID);

            // Show mission reminder
            const mission = Session.getField('mission');
            document.getElementById('mission-reminder').textContent = mission || 'No mission saved';

            // Load saved objectives
            for (let i = 0; i < 3; i++) {
                const saved = Session.getField(`objectives.${i}`);
                if (saved) {
                    document.getElementById(`objectives_${i}`).value = saved;
                }
            }

            // Load chat history
            loadChatHistory();

            // Auto-save for all inputs
            document.querySelectorAll('input[data-field]').forEach(input => {
                input.addEventListener('input', (e) => {
                    Session.saveField(e.target.dataset.field, e.target.value);
                });
            });
        });

        function loadChatHistory() {
            const history = Session.getChatHistory(MOMENT_ID);
            history.forEach(msg => {
                addMessageToChat(msg.role, msg.content, false);
            });
        }

        function addMessageToChat(role, content, save = true) {
            const container = document.getElementById('chat-messages');
            const isUser = role === 'user';

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.innerHTML = `
                <div class="chat-avatar">${isUser ? 'You' : 'AI'}</div>
                <div class="chat-bubble">
                    <p style="margin: 0;">${content}</p>
                </div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;

            if (save) {
                Session.saveChatMessage(MOMENT_ID, role, content);
            }
        }

        function showTyping() {
            const container = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="chat-avatar">AI</div>
                <div class="chat-bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            addMessageToChat('user', message);
            input.value = '';
            generateResponse(message);
        }

        function askQuestion(question) {
            addMessageToChat('user', question);
            generateResponse(question);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function generateResponse(userMessage) {
            showTyping();

            const goals = [
                document.getElementById('objectives_0').value.trim(),
                document.getElementById('objectives_1').value.trim(),
                document.getElementById('objectives_2').value.trim()
            ];
            const filledGoals = goals.filter(g => g);
            const messageLower = userMessage.toLowerCase();

            // Check for demo mode - use scripted responses
            if (Demo.isActive()) {
                setTimeout(() => {
                    hideTyping();
                    const demoResponse = Demo.getResponse(MOMENT_ID, userMessage);
                    if (demoResponse) {
                        addMessageToChat('assistant', demoResponse);
                        return;
                    }
                }, 1000);
                return;
            }

            setTimeout(() => {
                hideTyping();

                let response = '';

                if (messageLower.includes('realistic') || messageLower.includes('challenge')) {
                    if (filledGoals.length > 0) {
                        response = "Let me be direct about your goals:<br><br>";
                        goals.forEach((goal, i) => {
                            if (goal) {
                                const isVague = goal.match(/\b(grow|improve|better|more|increase)\b/i) && !goal.match(/\d/);
                                const isTooEasy = goal.match(/\b(logo|website|name|social media|business card)\b/i);
                                const hasNumber = goal.match(/\d+/);

                                response += `<strong>Goal ${i + 1}:</strong> "${goal}"<br>`;
                                if (isTooEasy) {
                                    response += "→ <strong>Red flag:</strong> This is a task, not a goal. A logo won't make or break your business. What actually matters?<br><br>";
                                } else if (isVague) {
                                    response += "→ <strong>Too vague.</strong> \"Grow\" how much? By when? How would you know if you achieved it?<br><br>";
                                } else if (hasNumber) {
                                    response += "→ <strong>Good</strong> — this is specific and measurable.<br><br>";
                                } else {
                                    response += "→ Could be stronger. Can you add a number or deadline?<br><br>";
                                }
                            }
                        });
                        response += "<strong>The real test:</strong> If you achieve these 3 goals, would you actually have a working business? Or just feel busy?";
                    } else {
                        response = "Enter your goals above first, and I'll challenge them!";
                    }
                } else if (messageLower.includes('missing')) {
                    const hasCapability = goals.some(g => g.toLowerCase().match(/skill|learn|build|create|develop|product|recipe|service/));
                    const hasCustomers = goals.some(g => g.toLowerCase().match(/customer|client|sell|market|find|paying|first/));
                    const hasOperations = goals.some(g => g.toLowerCase().match(/set up|operation|system|process|schedule|deliver|reliable/));

                    response = "Let me check what you're missing — because what you DON'T plan for is usually what kills a business:<br><br>";

                    if (hasCapability) {
                        response += "✓ <strong>Capability</strong> — you're thinking about what you need to build<br>";
                    } else {
                        response += "⚠️ <strong>Capability gap:</strong> Can you actually deliver what you're promising? What skills or products do you need first?<br>";
                    }

                    if (hasCustomers) {
                        response += "✓ <strong>Customers</strong> — you're thinking about finding buyers<br>";
                    } else {
                        response += "⚠️ <strong>Customer gap:</strong> This is the #1 reason businesses fail — no customers. How will people find you?<br>";
                    }

                    if (hasOperations) {
                        response += "✓ <strong>Operations</strong> — you're thinking about delivery<br>";
                    } else {
                        response += "⚠️ <strong>Operations gap:</strong> Can you do this reliably, week after week? What systems do you need?<br>";
                    }

                    response += "<br><strong>The question most people skip:</strong> Which of these would break your business fastest if you ignored it? That's your real priority.";
                } else if (messageLower.includes('example')) {
                    const idea = Session.getField('idea') ? Session.getField('idea').toLowerCase() : '';

                    if (idea.includes('food') || idea.includes('meal') || idea.includes('cook')) {
                        response = "Here's what worked for a meal prep entrepreneur I know:<br><br>" +
                            "• <strong>Goal 1:</strong> \"Get 5 paying customers in my zip code within 4 weeks\" — She started by asking neighbors, not strangers<br>" +
                            "• <strong>Goal 2:</strong> \"Perfect 10 recipes that I can make consistently and profitably\" — Not 50 recipes. Ten that work.<br>" +
                            "• <strong>Goal 3:</strong> \"Deliver on time every single week for 8 weeks straight\" — Reliability > variety<br><br>" +
                            "Notice: every goal has a <strong>number</strong> and a <strong>timeframe</strong>. That's how you know if you're succeeding.";
                    } else if (idea.includes('clean') || idea.includes('service')) {
                        response = "Here's what worked for a house cleaner starting out:<br><br>" +
                            "• <strong>Goal 1:</strong> \"Get 3 regular clients who pay on time\" — Not 20 one-time jobs. 3 recurring.<br>" +
                            "• <strong>Goal 2:</strong> \"Complete each clean in under 3 hours\" — Speed = profit<br>" +
                            "• <strong>Goal 3:</strong> \"Get 2 referrals from each happy client\" — Her only marketing was asking<br><br>" +
                            "The theme: small numbers, repeated consistently. Don't try to scale before you can deliver.";
                    } else {
                        response = "Here's a pattern that works across different businesses:<br><br>" +
                            "• <strong>Goal 1 (Customers):</strong> \"Get my first 5 paying customers within 30 days\" — Start with people you know<br>" +
                            "• <strong>Goal 2 (Capability):</strong> \"Deliver my service/product 10 times without a major problem\" — Prove you can do it reliably<br>" +
                            "• <strong>Goal 3 (Learning):</strong> \"Talk to every customer and write down what they actually want\" — Real feedback, not assumptions<br><br>" +
                            "Notice: I'm NOT saying \"build a website\" or \"create a logo.\" Those don't matter until you have customers.";
                    }
                } else if (messageLower.includes('which') || messageLower.includes('most') || messageLower.includes('priority') || messageLower.includes('first')) {
                    if (filledGoals.length > 0) {
                        response = "Let me be blunt: <strong>customers come first. Always.</strong><br><br>" +
                            "I see a lot of people spend months on capability and operations before they have a single paying customer. Then they find out nobody wants what they built.<br><br>" +
                            "Here's my challenge: <strong>Can you get ONE paying customer before working on anything else?</strong><br><br>" +
                            "Not a friend doing you a favor. Someone who pays real money because they want what you offer.<br><br>" +
                            "If you can do that, everything else gets easier. If you can't, you need to know that NOW, not after you've invested months of work.";
                    } else {
                        response = "Write your goals above first, and I'll help you prioritize!";
                    }
                } else {
                    // Default: engage with whatever they have
                    if (filledGoals.length > 0) {
                        response = `I see you're working on your goals. Let me ask you the hard question:<br><br>` +
                            `<strong>If you achieved all three of these goals, would you actually have a working business?</strong><br><br>` +
                            `Not "making progress." Not "feeling productive." An actual business with paying customers.<br><br>` +
                            `If the answer is "maybe" or "I'm not sure" — that's a sign your goals might be too vague or focused on the wrong things.<br><br>` +
                            `Would you like me to challenge your goals, or help you figure out what you might be missing?`;
                    } else {
                        response = `Start by writing your goals above. Don't overthink it — just answer:<br><br>` +
                            `<strong>What has to happen for your mission to become real?</strong><br><br>` +
                            `Most people focus on three areas:<br>` +
                            `1. <strong>Capability</strong> — What do you need to build or learn?<br>` +
                            `2. <strong>Customers</strong> — How will people find you and pay you?<br>` +
                            `3. <strong>Operations</strong> — What do you need to actually deliver?<br><br>` +
                            `Write something for each, and I'll help you make them stronger.`;
                    }
                }

                addMessageToChat('assistant', response);
            }, 1000 + Math.random() * 500);
        }

        function saveAndContinue() {
            const goals = [
                document.getElementById('objectives_0').value.trim(),
                document.getElementById('objectives_1').value.trim(),
                document.getElementById('objectives_2').value.trim()
            ];

            const filledGoals = goals.filter(g => g);
            if (filledGoals.length === 0) {
                alert('Please enter at least one goal before continuing.');
                document.getElementById('objectives_0').focus();
                return;
            }

            goals.forEach((goal, i) => {
                Session.saveField(`objectives.${i}`, goal);
            });

            Session.completeMoment(MOMENT_ID);
            window.location.href = Navigation.getUrlWithParams('moment-4.html');
        }
    </script>
</body>
</html>
